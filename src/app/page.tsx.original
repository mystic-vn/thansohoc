'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { getCookie, removeCookie } from '@/lib/cookies';
import { userApi } from '@/lib/api';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faSignOutAlt, faCaretDown, faUser } from '@fortawesome/free-solid-svg-icons';
import { calculateLifePathNumber, getZodiacSign, lifePathDescriptions, zodiacDescriptions, normalizeBirthDate, getCompatibility } from '@/lib/numerology';
import { FiLogOut, FiUser } from 'react-icons/fi';
import { Metadata } from 'next';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

type User = {
  id?: number | null;
  _id?: string;
  firstName?: string;
  lastName?: string;
  email?: string;
  birthDate?: string;
  isActive?: boolean;
  isVerified?: boolean;
  roles?: string[];
};

export default function HomePage() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [userName, setUserName] = useState('');
  const [userMenuOpen, setUserMenuOpen] = useState(false);
  const [userData, setUserData] = useState<any>(null);
  const [lifePathNumber, setLifePathNumber] = useState('');
  const [zodiacSign, setZodiacSign] = useState('');
  const [showMenu, setShowMenu] = useState(false);
  const [user, setUser] = useState<User | null>(null);
  const [compatibility, setCompatibility] = useState<string | null>(null);
  const [lifePathData, setLifePathData] = useState<any>(null);
  const [zodiacData, setZodiacData] = useState<any>(null);
  const [showLifePathDetails, setShowLifePathDetails] = useState(false);
  const [showZodiacDetails, setShowZodiacDetails] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [compatibilityData, setCompatibilityData] = useState<any>(null);

  useEffect(() => {
    // Kiểm tra xác thực
    const token = getCookie(process.env.NEXT_PUBLIC_AUTH_COOKIE_NAME || 'token');
    
    if (token) {
      setIsAuthenticated(true);
      // Lưu token vào localStorage để sử dụng cho API call
      if (typeof window !== 'undefined') {
        localStorage.setItem('token', token);
      }
      
      // Lấy thông tin người dùng từ API
      const fetchUserData = async () => {
        try {
          setIsLoading(true);
          console.log('Trang chủ: Bắt đầu lấy thông tin người dùng...');
          
          const userData = await userApi.getCurrentUser();
          
          if (!userData) {
            console.error('Trang chủ: Không nhận được dữ liệu người dùng');
            // Vẫn giữ người dùng đã xác thực, nhưng không có dữ liệu để hiển thị
            setIsLoading(false);
            return;
          }
          
          console.log('Trang chủ: Dữ liệu người dùng nhận được:', {
            id: userData.id || userData._id,
            email: userData.email,
            firstName: userData.firstName,
            lastName: userData.lastName,
            hasId: Boolean(userData.id || userData._id)
          });
          
          if (!userData.id && !userData._id) {
            console.error('Trang chủ: Dữ liệu người dùng không có ID');
            setIsAuthenticated(true); // Vẫn giữ người dùng đã xác thực
            setIsLoading(false);
            return;
          }
          
          // Đặt dữ liệu người dùng
          setUserData(userData);
          const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
          setUserName(fullName || 'Người dùng');
          
          if (typeof window !== 'undefined') {
            localStorage.setItem('userName', fullName || 'Người dùng');
          }
          
          // Tính toán số chủ đạo và cung hoàng đạo nếu có ngày sinh
          if (userData.birthDate) {
            try {
              console.log('Trang chủ: Ngày sinh gốc:', userData.birthDate);
              const normalizedDate = normalizeBirthDate(userData.birthDate);
              console.log('Trang chủ: Ngày sinh sau khi chuẩn hóa:', normalizedDate);
              
              const lpNumber = calculateLifePathNumber(userData.birthDate);
              const zodiac = getZodiacSign(userData.birthDate);
              
              console.log('Trang chủ: Số chủ đạo:', lpNumber);
              console.log('Trang chủ: Cung hoàng đạo:', zodiac);
              
              setLifePathNumber(lpNumber);
              setZodiacSign(zodiac);

              // Lấy dữ liệu số chủ đạo từ database
              try {
                const lifePathResponse = await fetch(`/api/numerology?type=life-path&code=${lpNumber}`);
                if (lifePathResponse.ok) {
                  const lifePathResult = await lifePathResponse.json();
                  if (lifePathResult.data) {
                    setLifePathData(lifePathResult.data);
                    console.log('Trang chủ: Lấy dữ liệu số chủ đạo từ database thành công', lifePathResult.data);
                  }
                }

                const zodiacResponse = await fetch(`/api/numerology?type=zodiac&code=${zodiac}`);
                if (zodiacResponse.ok) {
                  const zodiacResult = await zodiacResponse.json();
                  if (zodiacResult.data) {
                    setZodiacData(zodiacResult.data);
                    console.log('Trang chủ: Lấy dữ liệu cung hoàng đạo từ database thành công', zodiacResult.data);
                  }
                }
              } catch (error) {
                console.error('Trang chủ: Lỗi khi lấy dữ liệu từ database:', error);
              }
            } catch (error) {
              console.error('Trang chủ: Lỗi khi tính toán thông tin chiêm tinh:', error);
            }
          }
        } catch (error) {
          console.error('Trang chủ: Lỗi khi lấy thông tin người dùng:', error);
        } finally {
          setIsLoading(false);
        }
      };
      
      fetchUserData();
    } else {
      console.log('Trang chủ: Không tìm thấy token xác thực, chuyển hướng đến trang đăng nhập');
      // Chuyển hướng người dùng đến trang đăng nhập nếu chưa đăng nhập
      router.push('/login');
      setIsLoading(false);
    }
  }, [router]);

  // Lấy dữ liệu tương hợp từ API
  useEffect(() => {
    if (lifePathNumber && zodiacSign && isAuthenticated) {
      console.log("Trang chủ: Bắt đầu lấy dữ liệu tương hợp với params:", {
        lifePathNumber,
        zodiacSign
      });
      
      const fetchCompatibilityData = async () => {
        try {
          const apiUrl = `/api/numerology/compatibility?type=life-path-zodiac&factor1Type=life-path&factor1Code=${lifePathNumber}&factor2Type=zodiac&factor2Code=${zodiacSign}`;
          console.log("Trang chủ: Gọi API", apiUrl);
          
          const response = await fetch(apiUrl);
          
          if (!response.ok) {
            const errorData = await response.json();
            console.error('Trang chủ: API trả về lỗi:', response.status, errorData);
            return;
          }
          
          const data = await response.json();
          if (data.data) {
            console.log('Trang chủ: Lấy dữ liệu tương hợp từ API thành công', data.data);
            setCompatibilityData(data.data);
          } else {
            console.log('Trang chủ: API không trả về dữ liệu', data);
          }
        } catch (error) {
          console.error('Trang chủ: Lỗi khi lấy dữ liệu tương hợp:', error);
        }
      };
      
      fetchCompatibilityData();
    } else {
      console.log("Trang chủ: Không đủ thông tin để lấy dữ liệu tương hợp", {
        lifePathNumber,
        zodiacSign,
        isAuthenticated
      });
    }
  }, [lifePathNumber, zodiacSign, isAuthenticated]);

  const handleLogout = () => {
    // Đăng xuất người dùng
    userApi.logout();
    removeCookie(process.env.NEXT_PUBLIC_AUTH_COOKIE_NAME || 'token');
    setIsAuthenticated(false);
    router.push('/login');
  };

  const toggleUserMenu = () => {
    setUserMenuOpen(!userMenuOpen);
  };

  const handleLogin = () => {
    router.push('/login');
  };

  const toggleMenu = () => {
    setShowMenu(!showMenu);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-indigo-900 via-purple-800 to-pink-800 text-white">
      {/* Header */}
      <header className="bg-black/30 backdrop-blur-md">
        <div className="container mx-auto py-4 px-4 flex justify-between items-center">
          <Link href="/" className="flex items-center space-x-2">
            <div className="text-xl font-bold">Thần Số Học</div>
          </Link>
          <nav className="flex items-center space-x-4">
            {isAuthenticated ? (
              <>
                <Link href="/numerology" className="px-4 py-2 rounded hover:bg-indigo-600/30 transition">
                  Thần Số Học
                </Link>
                <Link href="/astrology" className="px-4 py-2 rounded hover:bg-indigo-600/30 transition">
                  Cung Hoàng Đạo
                </Link>
                <div className="relative">
                  <button 
                    onClick={toggleMenu}
                    className="flex items-center px-4 py-2 rounded hover:bg-indigo-600/30 transition"
                  >
                    <span className="mr-1">Xin chào, {userName}</span>
                    <FiUser className="ml-1 text-xs" />
                  </button>
                  {showMenu && (
                    <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                      <Link 
                        href="/profile"
                        className="flex items-center w-full text-gray-700 px-4 py-2 text-sm hover:bg-gray-100"
                      >
                        <FiUser className="mr-2" />
                        Trang cá nhân
                      </Link>
                      <button
                        onClick={handleLogout}
                        className="flex items-center w-full text-gray-700 px-4 py-2 text-sm hover:bg-gray-100"
                      >
                        <FiLogOut className="mr-2" />
                        Đăng xuất
                      </button>
                    </div>
                  )}
                </div>
              </>
            ) : (
              <>
                <Link href="/login" className="px-4 py-2 rounded hover:bg-indigo-600/30 transition">
                  Đăng nhập
                </Link>
                <Link 
                  href="/register" 
                  className="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full hover:from-indigo-600 hover:to-purple-700 transition"
                >
                  Đăng ký
                </Link>
              </>
            )}
          </nav>
        </div>
      </header>

      {isAuthenticated ? (
        <>
          {/* Hiển thị thông tin cá nhân cho người dùng đã đăng nhập */}
          <section className="py-16 px-4">
            <div className="container mx-auto max-w-6xl">
              <div className="text-center mb-10">
                <h1 className="text-4xl font-bold mb-4">Chào mừng, {userName}</h1>
                
                {lifePathNumber && zodiacSign ? (
                  <p className="text-xl text-white/80">
                    Bạn là người có Số Chủ Đạo <span className="text-pink-400 font-semibold">{lifePathNumber}</span> và 
                    thuộc cung <span className="text-blue-400 font-semibold">{zodiacSign}</span>
                  </p>
                ) : (
                  <p className="text-xl text-white/80">
                    Cập nhật ngày sinh trong <Link href="/profile" className="text-pink-400 hover:text-pink-300 transition">hồ sơ cá nhân</Link> để khám phá thông tin thần số học của bạn
                  </p>
                )}
              </div>
              
              {lifePathNumber && zodiacSign ? (
                <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 border border-white/20 shadow-2xl mb-12">
                  <div className="flex flex-col lg:flex-row gap-8">
                    <div className="flex-1">
                      <div className="flex items-center mb-4">
                        <div className="h-16 w-16 rounded-full flex items-center justify-center bg-gradient-to-br from-pink-500 to-orange-500 text-2xl font-bold mr-4">
                          {lifePathNumber}
                        </div>
                        <h2 className="text-2xl font-bold">Số Chủ Đạo: {lifePathNumber}</h2>
                      </div>
                      <div className="text-white/90">
                        {lifePathData ? (
                          <>
                            <p className="mb-4">{lifePathData.overview}</p>
                            
                            <div className="mt-4">
                              <h3 className="text-lg font-semibold mb-2">Đặc điểm nổi bật:</h3>
                              <ul className="list-disc pl-5 space-y-1 text-white/80">
                                {lifePathData.traits && lifePathData.traits.length > 0 ? (
                                  lifePathData.traits.slice(0, 3).map((trait: string, index: number) => (
                                    <li key={index}>{trait}</li>
                                  ))
                                ) : (
                                  <>
                                    {lifePathNumber === '1' && (
                                      <>
                                        <li>Tính độc lập và quyết đoán cao</li>
                                        <li>Khả năng lãnh đạo và sáng tạo</li>
                                        <li>Tham vọng và ý chí mạnh mẽ</li>
                                      </>
                                    )}
                                    {lifePathNumber === '2' && (
                                      <>
                                        <li>Nhạy cảm và trực giác tốt</li>
                                        <li>Khả năng làm việc nhóm xuất sắc</li>
                                        <li>Thiên về hòa giải và cân bằng</li>
                                      </>
                                    )}
                                    {lifePathNumber === '3' && (
                                      <>
                                        <li>Sáng tạo và biểu đạt tốt</li>
                                        <li>Năng lượng tích cực và vui vẻ</li>
                                        <li>Khả năng giao tiếp và truyền cảm hứng</li>
                                      </>
                                    )}
                                    {lifePathNumber === '4' && (
                                      <>
                                        <li>Đáng tin cậy và thực tế</li>
                                        <li>Có tổ chức và phương pháp</li>
                                        <li>Kiên trì và chăm chỉ</li>
                                      </>
                                    )}
                                    {lifePathNumber === '5' && (
                                      <>
                                        <li>Yêu tự do và phiêu lưu</li>
                                        <li>Thích nghi nhanh với thay đổi</li>
                                        <li>Tò mò và ham học hỏi</li>
                                      </>
                                    )}
                                    {lifePathNumber === '6' && (
                                      <>
                                        <li>Giàu lòng trắc ẩn và trách nhiệm</li>
                                        <li>Quan tâm đến gia đình và cộng đồng</li>
                                        <li>Yêu thương và chăm sóc người khác</li>
                                      </>
                                    )}
                                    {lifePathNumber === '7' && (
                                      <>
                                        <li>Tư duy phân tích sâu sắc</li>
                                        <li>Trực giác mạnh mẽ</li>
                                        <li>Ham học hỏi và nghiên cứu</li>
                                      </>
                                    )}
                                    {lifePathNumber === '8' && (
                                      <>
                                        <li>Tài năng quản lý và tổ chức</li>
                                        <li>Hướng đến thành công và thịnh vượng</li>
                                        <li>Quyết đoán và tự tin</li>
                                      </>
                                    )}
                                    {lifePathNumber === '9' && (
                                      <>
                                        <li>Tinh thần nhân đạo và vị tha</li>
                                        <li>Hiểu biết sâu rộng và khôn ngoan</li>
                                        <li>Sáng tạo và truyền cảm hứng</li>
                                      </>
                                    )}
                                    {lifePathNumber === '11' && (
                                      <>
                                        <li>Trực giác cao và nhạy cảm</li>
                                        <li>Tầm nhìn tâm linh và siêu hình</li>
                                        <li>Khả năng truyền cảm hứng và giác ngộ</li>
                                      </>
                                    )}
                                    {lifePathNumber === '22' && (
                                      <>
                                        <li>Năng lực xây dựng những điều vĩ đại</li>
                                        <li>Tầm nhìn thực tế và cách mạng</li>
                                        <li>Khả năng biến ước mơ thành hiện thực</li>
                                      </>
                                    )}
                                    {lifePathNumber === '33' && (
                                      <>
                                        <li>Tinh thần phụng sự cao cả</li>
                                        <li>Tình yêu vô điều kiện</li>
                                        <li>Khả năng chữa lành và chỉ dẫn</li>
                                      </>
                                    )}
                                  </>
                                )}
                              </ul>
                              <button 
                                onClick={() => setShowLifePathDetails(true)} 
                                className="inline-block mt-3 text-sm text-indigo-300 hover:text-indigo-200 transition"
                              >
                                Xem chi tiết →
                              </button>
                            </div>
                          </>
                        ) : (
                          <div className="space-y-6">
                            <div>
                              <h3 className="text-xl font-semibold mb-2">{lifePathDescriptions[lifePathNumber] ? lifePathDescriptions[lifePathNumber].title : "Tổng quan"}</h3>
                              <p className="text-white/90">{lifePathDescriptions[lifePathNumber] ? lifePathDescriptions[lifePathNumber].description : ""}</p>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div>
                                <h3 className="text-xl font-semibold mb-2">Điểm mạnh</h3>
                                <ul className="list-disc pl-5 space-y-1 text-white/90">
                                  {lifePathDescriptions[lifePathNumber] && lifePathDescriptions[lifePathNumber].strengths.map((strength: string, index: number) => (
                                    <li key={index}>{strength}</li>
                                  ))}
                                </ul>
                              </div>
                              <div>
                                <h3 className="text-xl font-semibold mb-2">Điểm yếu</h3>
                                <ul className="list-disc pl-5 space-y-1 text-white/90">
                                  {lifePathDescriptions[lifePathNumber] && lifePathDescriptions[lifePathNumber].weaknesses.map((weakness: string, index: number) => (
                                    <li key={index}>{weakness}</li>
                                  ))}
                                </ul>
                              </div>
                            </div>
                            
                            <div className="pt-4 flex justify-center">
                              <Link 
                                href="/numerology" 
                                className="px-6 py-3 bg-gradient-to-r from-pink-500 to-orange-500 rounded-full text-sm font-medium hover:from-pink-600 hover:to-orange-600 transition shadow-lg"
                              >
                                Xem tất cả số thần số học của bạn
                              </Link>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className="flex-1">
                      <div className="flex items-center mb-4">
                        <div className="h-16 w-16 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-500 text-2xl mr-4">
                          {zodiacSign === 'Bạch Dương' && '♈'}
                          {zodiacSign === 'Kim Ngưu' && '♉'}
                          {zodiacSign === 'Song Tử' && '♊'}
                          {zodiacSign === 'Cự Giải' && '♋'}
                          {zodiacSign === 'Sư Tử' && '♌'}
                          {zodiacSign === 'Xử Nữ' && '♍'}
                          {zodiacSign === 'Thiên Bình' && '♎'}
                          {zodiacSign === 'Bọ Cạp' && '♏'}
                          {zodiacSign === 'Nhân Mã' && '♐'}
                          {zodiacSign === 'Ma Kết' && '♑'}
                          {zodiacSign === 'Bảo Bình' && '♒'}
                          {zodiacSign === 'Song Ngư' && '♓'}
                        </div>
                        <h2 className="text-2xl font-bold">Cung Hoàng Đạo: {zodiacSign}</h2>
                      </div>
                      <div className="text-white/90">
                        {zodiacData ? (
                          <>
                            <p className="mb-4">{zodiacData.overview || zodiacData.description}</p>
                            <div className="mt-4">
                              <h3 className="text-lg font-semibold mb-2">Đặc điểm nổi bật:</h3>
                              <ul className="list-disc pl-5 space-y-1 text-white/80">
                                {zodiacData.traits && zodiacData.traits.length > 0 ? (
                                  zodiacData.traits.slice(0, 3).map((trait: string, index: number) => (
                                    <li key={index}>{trait}</li>
                                  ))
                                ) : (
                                  zodiacData.strengths.slice(0, 3).map((strength: string, index: number) => (
                                    <li key={index}>{strength}</li>
                                  ))
                                )}
                              </ul>
                              <button 
                                onClick={() => setShowZodiacDetails(true)} 
                                className="inline-block mt-3 text-sm text-indigo-300 hover:text-indigo-200 transition"
                              >
                                Xem chi tiết →
                              </button>
                            </div>
                          </>
                        ) : (
                          <div className="space-y-6">
                            <div className="text-center mb-4">
                              <p className="text-lg">
                                <span className="font-medium">Nguyên tố:</span> {zodiacData?.element || ""}
                              </p>
                            </div>
                            
                            <div>
                              <h3 className="text-xl font-semibold mb-2">Tổng quan</h3>
                              <p className="text-white/90">{zodiacData?.overview || zodiacData?.description || ""}</p>
                            </div>
                            
                            {zodiacData?.traits && zodiacData.traits.length > 0 && (
                              <div>
                                <h3 className="text-xl font-semibold mb-2">Đặc điểm chính</h3>
                                <ul className="list-disc pl-5 space-y-1 text-white/90">
                                  {zodiacData.traits.map((trait: string, index: number) => (
                                    <li key={index}>{trait}</li>
                                  ))}
                                </ul>
                              </div>
                            )}
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              {zodiacData?.strengths && zodiacData.strengths.length > 0 && (
                                <div>
                                  <h3 className="text-xl font-semibold mb-2">Điểm mạnh</h3>
                                  <ul className="list-disc pl-5 space-y-1 text-white/90">
                                    {zodiacData.strengths.map((strength: string, index: number) => (
                                      <li key={index}>{strength}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {zodiacData?.weaknesses && zodiacData.weaknesses.length > 0 && (
                                <div>
                                  <h3 className="text-xl font-semibold mb-2">Điểm yếu</h3>
                                  <ul className="list-disc pl-5 space-y-1 text-white/90">
                                    {zodiacData.weaknesses.map((weakness: string, index: number) => (
                                      <li key={index}>{weakness}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                            </div>
                            
                            {zodiacData?.symbols && zodiacData.symbols.length > 0 && (
                              <div>
                                <h3 className="text-xl font-semibold mb-2">Biểu tượng</h3>
                                <ul className="list-disc pl-5 space-y-1 text-white/90">
                                  {zodiacData.symbols.map((symbol: string, index: number) => (
                                    <li key={index}>{symbol}</li>
                                  ))}
                                </ul>
                              </div>
                            )}

                            {zodiacData?.famous_people && zodiacData.famous_people.length > 0 && (
                              <div>
                                <h3 className="text-xl font-semibold mb-2">Nhân vật nổi tiếng</h3>
                                <ul className="list-disc pl-5 space-y-1 text-white/90">
                                  {zodiacData.famous_people.map((person: string, index: number) => (
                                    <li key={index}>{person}</li>
                                  ))}
                                </ul>
                              </div>
                            )}

                            {zodiacData?.lucky_elements && (
                              <div>
                                <h3 className="text-xl font-semibold mb-2">Yếu tố may mắn</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-white/90">
                                  {zodiacData.lucky_elements.colors && zodiacData.lucky_elements.colors.length > 0 && (
                                    <div>
                                      <h4 className="text-lg font-medium mb-1">Màu sắc:</h4>
                                      <p>{zodiacData.lucky_elements.colors.join(", ")}</p>
                                    </div>
                                  )}
                                  {zodiacData.lucky_elements.numbers && zodiacData.lucky_elements.numbers.length > 0 && (
                                    <div>
                                      <h4 className="text-lg font-medium mb-1">Số may mắn:</h4>
                                      <p>{zodiacData.lucky_elements.numbers.join(", ")}</p>
                                    </div>
                                  )}
                                  {zodiacData.lucky_elements.days && zodiacData.lucky_elements.days.length > 0 && (
                                    <div>
                                      <h4 className="text-lg font-medium mb-1">Ngày may mắn:</h4>
                                      <p>{zodiacData.lucky_elements.days.join(", ")}</p>
                                    </div>
                                  )}
                                  {zodiacData.lucky_elements.gemstones && zodiacData.lucky_elements.gemstones.length > 0 && (
                                    <div>
                                      <h4 className="text-lg font-medium mb-1">Đá quý:</h4>
                                      <p>{zodiacData.lucky_elements.gemstones.join(", ")}</p>
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                            
                            {zodiacData?.details && (
                              <div className="space-y-4">
                                <h3 className="text-xl font-semibold mb-2">Chi tiết</h3>
                                
                                {zodiacData.details.compatibility && (
                                  <div>
                                    <h4 className="text-lg font-medium mb-1">Tương hợp</h4>
                                    <p className="text-white/90">{zodiacData.details.compatibility}</p>
                                  </div>
                                )}
                                
                                {zodiacData.details.career && (
                                  <div>
                                    <h4 className="text-lg font-medium mb-1">Sự nghiệp</h4>
                                    <p className="text-white/90">{zodiacData.details.career}</p>
                                  </div>
                                )}
                                
                                {zodiacData.details.love && (
                                  <div>
                                    <h4 className="text-lg font-medium mb-1">Tình yêu</h4>
                                    <p className="text-white/90">{zodiacData.details.love}</p>
                                  </div>
                                )}

                                {zodiacData.details.health && (
                                  <div>
                                    <h4 className="text-lg font-medium mb-1">Sức khỏe</h4>
                                    <p className="text-white/90">{zodiacData.details.health}</p>
                                  </div>
                                )}

                                {zodiacData.details.personality && (
                                  <div>
                                    <h4 className="text-lg font-medium mb-1">Tính cách</h4>
                                    <p className="text-white/90">{zodiacData.details.personality}</p>
                                  </div>
                                )}
                              </div>
                            )}

                            {zodiacData?.compatibility && (
                              <div>
                                <h3 className="text-xl font-semibold mb-2">Tương hợp</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 text-white/90">
                                  {zodiacData.compatibility.most_compatible && zodiacData.compatibility.most_compatible.length > 0 && (
                                    <div>
                                      <h4 className="text-lg font-medium mb-1">Hợp nhất với:</h4>
                                      <p>{zodiacData.compatibility.most_compatible.join(", ")}</p>
                                    </div>
                                  )}
                                  {zodiacData.compatibility.least_compatible && zodiacData.compatibility.least_compatible.length > 0 && (
                                    <div>
                                      <h4 className="text-lg font-medium mb-1">Ít hợp với:</h4>
                                      <p>{zodiacData.compatibility.least_compatible.join(", ")}</p>
                                    </div>
                                  )}
                                </div>
                                {zodiacData.compatibility.compatibility_explanation && (
                                  <p className="text-white/90">{zodiacData.compatibility.compatibility_explanation}</p>
                                )}
                              </div>
                            )}
                            
                            <div className="pt-4 flex justify-center">
                              <Link 
                                href="/astrology" 
                                className="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full text-sm font-medium hover:from-blue-600 hover:to-purple-600 transition shadow-lg"
                              >
                                Xem tất cả cung hoàng đạo
                              </Link>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* Phần kết hợp số chủ đạo và cung hoàng đạo */}
                  <div className="mt-10 pt-8 border-t border-white/20">
                    <h2 className="text-2xl font-bold mb-6 text-center">Sự kết hợp độc đáo của bạn</h2>
                    
                    <div className="bg-gradient-to-r from-purple-800/40 to-pink-600/40 rounded-xl p-8 border border-white/10 shadow-xl backdrop-blur-sm">
                      <div className="flex items-center justify-center mb-6">
                        <div className="h-16 w-16 rounded-full flex items-center justify-center bg-gradient-to-br from-pink-500 to-indigo-500 text-2xl">
                          {lifePathNumber}
                        </div>
                        <div className="mx-4 text-2xl font-light opacity-75">✦</div>
                        <div className="h-16 w-16 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-500 text-2xl">
                          {zodiacSign === 'Bạch Dương' && '♈'}
                          {zodiacSign === 'Kim Ngưu' && '♉'}
                          {zodiacSign === 'Song Tử' && '♊'}
                          {zodiacSign === 'Cự Giải' && '♋'}
                          {zodiacSign === 'Sư Tử' && '♌'}
                          {zodiacSign === 'Xử Nữ' && '♍'}
                          {zodiacSign === 'Thiên Bình' && '♎'}
                          {zodiacSign === 'Bọ Cạp' && '♏'}
                          {zodiacSign === 'Nhân Mã' && '♐'}
                          {zodiacSign === 'Ma Kết' && '♑'}
                          {zodiacSign === 'Bảo Bình' && '♒'}
                          {zodiacSign === 'Song Ngư' && '♓'}
                        </div>
                      </div>

                      {compatibilityData && compatibilityData.compatibilityScore !== undefined && (
                        <div className="mb-6">
                          <div className="flex justify-center mb-4">
                            <div className="bg-gradient-to-r from-indigo-500/30 to-purple-500/30 rounded-full px-4 py-1 text-sm font-medium">
                              Điểm tương hợp: {compatibilityData.compatibilityScore}/10
                            </div>
                          </div>
                          
                          <div className="flex justify-center">
                            <div className="relative w-full max-w-sm">
                              <div className="absolute inset-0 flex items-center justify-center">
                                <span className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-indigo-500">
                                  {compatibilityData.compatibilityScore}/10
                                </span>
                              </div>
                              <div className="h-5 w-full bg-white/10 rounded-full overflow-hidden border border-white/20">
                                <div 
                                  className="h-full bg-gradient-to-r from-pink-500 to-indigo-500" 
                                  style={{ width: `${(compatibilityData.compatibilityScore / 10) * 100}%` }}
                                ></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      <div className="mb-8">
                        <p className="text-white/90 text-lg text-center italic mb-6">
                          "Sự giao thoa giữa số chủ đạo và cung hoàng đạo tạo nên bản sắc độc nhất của bạn"
                        </p>
                        
                        <p className="text-white/95">
                          {compatibilityData ? compatibilityData.overview : 
                            getCompatibility(lifePathNumber, zodiacSign) || 
                            `Sự kết hợp giữa Số Chủ Đạo ${lifePathNumber} và cung ${zodiacSign} tạo nên một cá tính độc đáo. 
                            Bạn vừa mang đặc điểm của số ${lifePathNumber} như ${
                              lifePathNumber === '1' ? 'độc lập, sáng tạo và quyết đoán' : 
                              lifePathNumber === '2' ? 'hợp tác, cân bằng và nhạy cảm' :
                              lifePathNumber === '3' ? 'giao tiếp, sáng tạo và biểu đạt' :
                              lifePathNumber === '4' ? 'thực tế, chăm chỉ và có tổ chức' :
                              lifePathNumber === '5' ? 'tự do, phiêu lưu và thích nghi' :
                              lifePathNumber === '6' ? 'trách nhiệm, chăm sóc và hài hòa' :
                              lifePathNumber === '7' ? 'phân tích, trực giác và tâm linh' :
                              lifePathNumber === '8' ? 'quyền lực, tham vọng và thành công' :
                              lifePathNumber === '9' ? 'nhân đạo, sáng tạo và từ thiện' :
                              lifePathNumber === '11' ? 'trực giác cao, tâm linh và lý tưởng' :
                      {compatibilityData.compatibility_breakdown.emotional !== undefined && (
                        <div className="bg-white/10 rounded-lg p-3 text-center">
                          <h4 className="text-sm font-medium text-white/70 mb-1">Cảm xúc</h4>
                          <div className="relative pt-1">
                            <div className="text-lg font-semibold text-pink-300 mb-1">
                              {compatibilityData.compatibility_breakdown.emotional}/10
                            </div>
                            <div className="overflow-hidden h-2 text-xs flex rounded bg-white/20">
                              <div 
                                style={{ width: `${(compatibilityData.compatibility_breakdown.emotional / 10) * 100}%` }} 
                                className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-pink-500"
                              />
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {compatibilityData.compatibility_breakdown.spiritual !== undefined && (
                        <div className="bg-white/10 rounded-lg p-3 text-center">
                          <h4 className="text-sm font-medium text-white/70 mb-1">Tâm linh</h4>
                          <div className="relative pt-1">
                            <div className="text-lg font-semibold text-purple-300 mb-1">
                              {compatibilityData.compatibility_breakdown.spiritual}/10
                            </div>
                            <div className="overflow-hidden h-2 text-xs flex rounded bg-white/20">
                              <div 
                                style={{ width: `${(compatibilityData.compatibility_breakdown.spiritual / 10) * 100}%` }} 
                                className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-purple-500"
                              />
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {compatibilityData.compatibility_breakdown.practical !== undefined && (
                        <div className="bg-white/10 rounded-lg p-3 text-center">
                          <h4 className="text-sm font-medium text-white/70 mb-1">Thực tế</h4>
                          <div className="relative pt-1">
                            <div className="text-lg font-semibold text-green-300 mb-1">
                              {compatibilityData.compatibility_breakdown.practical}/10
                            </div>
                            <div className="overflow-hidden h-2 text-xs flex rounded bg-white/20">
                              <div 
                                style={{ width: `${(compatibilityData.compatibility_breakdown.practical / 10) * 100}%` }} 
                                className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500"
                              />
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {compatibilityData.compatibility_breakdown.description && (
                      <p className="text-white/90">{compatibilityData.compatibility_breakdown.description}</p>
                    )}
                  </div>
                )}
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="bg-white/5 rounded-lg p-5 backdrop-blur-sm">
                    <h3 className="text-lg font-semibold mb-3 text-green-300">Điểm Mạnh</h3>
                    <ul className="list-disc pl-5 space-y-2 text-white/90">
                      {compatibilityData.strengths.map((strength: string, index: number) => (
                        <li key={`strength-${index}`}>{strength}</li>
                      ))}
                    </ul>
                  </div>
                  
                  <div className="bg-white/5 rounded-lg p-5 backdrop-blur-sm">
                    <h3 className="text-lg font-semibold mb-3 text-orange-300">Thách Thức</h3>
                    <ul className="list-disc pl-5 space-y-2 text-white/90">
                      {compatibilityData.challenges.map((challenge: string, index: number) => (
                        <li key={`challenge-${index}`}>{challenge}</li>
                      ))}
                    </ul>
                  </div>
                </div>
                
                {/* Mô hình giao tiếp */}
                {compatibilityData.communication_patterns && (
                  <div className="bg-white/5 rounded-lg p-5 backdrop-blur-sm">
                    <h3 className="text-xl font-semibold mb-4 text-yellow-300">Mô hình giao tiếp</h3>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                      {compatibilityData.communication_patterns.strengths && compatibilityData.communication_patterns.strengths.length > 0 && (
                        <div>
                          <h4 className="text-lg font-medium mb-2">Điểm mạnh trong giao tiếp</h4>
                          <ul className="list-disc pl-5 space-y-1 text-white/90">
                            {compatibilityData.communication_patterns.strengths.map((item: string, index: number) => (
                              <li key={`comm-strength-${index}`}>{item}</li>
                            ))}
                          </ul>
                        </div>
                      )}
                      
                      {compatibilityData.communication_patterns.challenges && compatibilityData.communication_patterns.challenges.length > 0 && (
                        <div>
                          <h4 className="text-lg font-medium mb-2">Thách thức trong giao tiếp</h4>
                          <ul className="list-disc pl-5 space-y-1 text-white/90">
                            {compatibilityData.communication_patterns.challenges.map((item: string, index: number) => (
                              <li key={`comm-challenge-${index}`}>{item}</li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                    
                    {compatibilityData.communication_patterns.advice && (
                      <div>
                        <h4 className="text-lg font-medium mb-2">Lời khuyên cho giao tiếp hiệu quả</h4>
                        <p className="text-white/90">{compatibilityData.communication_patterns.advice}</p>
                      </div>
                    )}
                  </div>
                )}
                
                {/* Động lực trong mối quan hệ */}
                {compatibilityData.relationship_dynamics && (
                  <div className="bg-white/5 rounded-lg p-5 backdrop-blur-sm">
                    <h3 className="text-xl font-semibold mb-4 text-pink-300">Động lực trong mối quan hệ</h3>
                    
                    {compatibilityData.relationship_dynamics.personal && (
                      <div className="mb-4">
                        <h4 className="text-lg font-medium mb-2">Mối quan hệ cá nhân</h4>
                        <p className="text-white/90">{compatibilityData.relationship_dynamics.personal}</p>
                      </div>
                    )}
                    
                    {compatibilityData.relationship_dynamics.professional && (
                      <div className="mb-4">
                        <h4 className="text-lg font-medium mb-2">Môi trường làm việc</h4>
                        <p className="text-white/90">{compatibilityData.relationship_dynamics.professional}</p>
                      </div>
                    )}
                    
                    {compatibilityData.relationship_dynamics.friendship && (
                      <div>
                        <h4 className="text-lg font-medium mb-2">Tình bạn</h4>
                        <p className="text-white/90">{compatibilityData.relationship_dynamics.friendship}</p>
                      </div>
                    )}
                  </div>
                )}
                
                {/* Ví dụ nổi tiếng */}
                {compatibilityData.famous_examples && compatibilityData.famous_examples.length > 0 && (
                  <div className="bg-white/5 rounded-lg p-5 backdrop-blur-sm">
                    <h3 className="text-xl font-semibold mb-3">Ví dụ nổi tiếng</h3>
                    <ul className="list-disc pl-5 space-y-2 text-white/90">
                      {compatibilityData.famous_examples.map((example: string, index: number) => (
                        <li key={`example-${index}`}>{example}</li>
                      ))}
                    </ul>
                  </div>
                )}
                
                <div className="bg-white/5 rounded-lg p-5 backdrop-blur-sm">
                  <h3 className="text-xl font-semibold mb-3 text-blue-300">Lời Khuyên</h3>
                  <p className="text-white/90">{compatibilityData.advice}</p>
                </div>
              </div>
              
              <div className="flex justify-center mt-6">
                <button 
                  onClick={() => setShowDetailModal(false)}
                  className="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg text-white font-medium hover:from-indigo-600 hover:to-purple-700 transition shadow-lg"
                >
                  Đóng
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
